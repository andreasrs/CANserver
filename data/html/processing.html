<html>
    <head>
        <title>Scripts</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" href="data:,">
        <link rel="stylesheet" type="text/css" href="/css/canserver.css">
        <link rel="stylesheet" type="text/css" href="/css/app.css">
        <script src="/js/zepto.min.js"></script>
        <script src="/js/app.js"></script>
        <script src="/js/canserver.js"></script>
    </head>
    <body>
      <nav>
        <ul>
          <li><a href="/" tabindex="1">Status</a></li><li><a href="/displays">Displays</a></li><li><a href="/network">Network</a></li><li><a href="/analysis">Analysis</a></li><li class="active"><a href="/processing">Scripts</a></li><li><a href="/logs">Logs</a></li><li><a href="/debug">Debug</a></li>
        </ul>
      </nav>
      <main id="scripts">
        <H1>Processing Script</H1>
        Status: <span id="scriptstate">Unknown</span> 
        <span id="errormessage" style="display:none;"></span>
        <div id="scriptstats" style="display:none;">
          Times (ms) - 
          Mean: <span id="meantime"></span>
          Max: <span id="maxtime"></span>
          Min: <span id="mintime"></span>
          StdDev: <span id="stddevtime"></span>
        </div>
        
        <div id="wrapper">Loading...</div>
        <br>
        <button id="save" style="display:none;" onclick="saveScript();">Save</button>
        <script>
          function initialLoad() {
            $.get('/processing_script', function(response){
              $textarea = $("<textarea>").attr('id', 'processingscript').attr('spellcheck', 'false').val(response);
              
              $('div#wrapper').html('').append($textarea);
              $('button#save').show();
              
              TLN.append_line_numbers('processingscript');
              wrapper.style.width='1000px';
              wrapper.style.height='650px';
              
              $(document).delegate('#processingscript', 'keydown', function(e) {
                var keyCode = e.keyCode || e.which;
              
                if (keyCode == 9) {
                  e.preventDefault();
                  var start = this.selectionStart;
                  var end = this.selectionEnd;
              
                  // set textarea value to: text before caret + tab + text after caret
                  $(this).val($(this).val().substring(0, start)
                              + "\t"
                              + $(this).val().substring(end));
              
                  // put caret at right position again
                  this.selectionStart =
                  this.selectionEnd = start + 1;
                }
              });
              
              loadStatus();
            });
          }
          
          function saveScript() {
            postInfo = {};
             
            postInfo['script'] = $('div#wrapper textarea').val();
            
            $.ajax({
              url: "/processing_save",
              type: 'POST',
              data: postInfo,
              success: function(data) {
                loadStatus();
              }
            });
          }
          
          function loadStatus() {
            $.get('/processing_stats', function(response){
              if (response.state == true)
              {
                $('span#scriptstate').html('Good').addClass("good").removeClass('bad');
                
                $('span#meantime').html(response.mean);
                $('span#maxtime').html(response.max);
                $('span#mintime').html(response.min);
                $('span#stddevtime').html(response.stddev);
                
                $('div#scriptstats').show();
                $('span#errormessage').hide();
              }
              else
              {
                $('span#scriptstate').html('Bad').addClass("bad").removeClass('good');
                $('div#scriptstats').hide();
                $('span#errormessage').show().html(response.errorstring);
              }
            });
          }
          
          initialLoad();
          setInterval('loadStatus()', 5000);
        </script>
      </main>
      <footer>
        <span>
          Github: <a href="https://github.com/joshwardell/CANserver">https://github.com/joshwardell/CANserver</a>
        </span>
        <span>
        <label for="theme">Visual theme:</label>
          <select name="theme" id="theme">
            <option value="business">Business</option>
            <option value="pastel">Pastel</option>
          </select> 
        </span>
      </footer>
    </body>
</html>