<html>
    <head>
        <title>Analysis</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" href="data:,">
        <link rel="stylesheet" type="text/css" href="/css/canserver.css">
        <script src="/js/canserver.js"></script>
        <style>
          body {font-family: sans-serif;}
          
          tr td {
            text-align: center;
            padding: 2px 5px;
          }
          input.frameid, input.startbit, input.bitlength, input.factor, input.signaloffset {
            width:50px;
          }
                    
          tbody tr:nth-child(even) {
            background-color: lightgrey; 
          }
        </style>
    </head>
    <body>
      <nav>
        <ul>
          <li><a href="/" tabindex="1">Status</a></li><li><a href="/config">Displays</a></li><li><a href="/network">Network</a></li><li class="active"><a href="/analysis">Analysis</a></li><li><a href="/logs">Logs</a></li><li><a href="/debug">Debug</a></li>
        </ul>
      </nav>
      <main id="analysis">
        <h1>Analysis</h1>
        <div id="dynamicanalysisitems">
          <table>
            <thead>
              <tr>
                <th style="width: 161px;">Name</th>
                <th style="width: 70px;">Frame ID</th>
                <th style="width: 64px;">Start Bit</th>
                <th style="width: 80px;">Bit Length</th>
                <th style="width: 58px;">Factor</th>
                <th style="width: 100px;">Signal Offset</th>
                <th style="width: 72px;">Is Signed</th>
                <th style="width: 96px;">Little Endian</th>
                <th style="width: 68px;">Value</th>
                <th style="width: 50px;">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr id="loading">
                <td colspan="10" style="text-align:left !important">Loading...</td>
              </tr>
            </tbody>
            <tfoot>
              <tr id="noitems" class="hidden">
                <td colspan="10" style="text-align:left !important">No items</td>
              </tr>
              <tr class="hidden" id="rowtemplate">
                <td>
                  <input class="name" name="name" value="" maxlength="10">
                </td>
                <td>
                  <input class="frameid" name="frameid" value="">
                </td>
                <td>
                  <input class="startbit" name="startbit" value="" type="number">
                </td>
                <td>
                  <input class="bitlength" name="bitlength" value="" type="number">
                </td>
                <td>
                  <input class="factor" name="factor" value="">
                </td>
                <td>
                  <input class="signaloffset" name="signaloffset" value="">
                </td>
                <td>
                  <input class="issigned" name="issigned" type="checkbox">
                </td>
                <td>
                  <input class="littleendian" name="littleendian" type="checkbox">
                </td>
                <td class="value"> --- </td>
                <td>
                  <a alt="Save" title="Save" href="javascript:void(0);" onclick="saveItem(this);"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAH+SURBVBgZBcE9i11VGAbQtc/sO0OCkqhghEREAwpWAWUg8aMVf4KFaJEqQtAipTZWViKiCGOh2Ap2gmJhlSIWFsFOxUK0EsUM3pl79n4f12qHb3z3Fh7D83gC95GOJsDe0ixLk5Qq/+xv/Lw9Xd+78/HLX3Y8fXTr2nWapy4eCFKxG7Fby97SnDlYtMbxthyfzHO//nl85fNvfvnk8MbX5xa8IHx1518Vkrj54Q+qQms2vVmWZjdiu5ZR2rT01166/NCZg/2PFjwSVMU6yjoC1oq+x6Y3VbHdlXWExPd379nf7Nmejv2Os6OC2O4KLK0RNn3RNCdr2Z5GJSpU4o+/TkhaJ30mEk5HwNuvX7Hpi76wzvjvtIwqVUSkyjqmpHS0mki8+9mPWmuWxqYvGkbFGCUAOH/+QevYI9GFSqmaHr5wkUYTAlGhqiRRiaqiNes6SOkwJwnQEqBRRRJEgkRLJGVdm6R0GLMQENE0EkmkSkQSVVMqopyuIaUTs0J455VLAAAAAODW0U/GiKT0pTWziEj44PZ1AAAAcPPqkTmH3QiJrlEVDXDt0qsAAAAAapa5BqUnyaw0Am7//gUAAAB49tEXzTmtM5KkV/y2G/X4M5fPao03n/sUAAAAwIX7y5yBv9vhjW/fT/IkuSp5gJKElKRISYoUiSRIyD1tufs/IXxui20QsKIAAAAASUVORK5CYII="></a>
                  <a alt="Delete" title="Delete" href="javascript:void(0);" onclick="deleteItem(this);"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJdSURBVDjLpZP7S1NhGMf9W7YfogSJboSEUVCY8zJ31trcps6zTI9bLGJpjp1hmkGNxVz4Q6ildtXKXzJNbJRaRmrXoeWx8tJOTWptnrNryre5YCYuI3rh+8vL+/m8PA/PkwIg5X+y5mJWrxfOUBXm91QZM6UluUmthntHqplxUml2lciF6wrmdHriI0Wx3xw2hAediLwZRWRkCPzdDswaSvGqkGCfq8VEUsEyPF1O8Qu3O7A09RbRvjuIttsRbT6HHzebsDjcB4/JgFFlNv9MnkmsEszodIIY7Oaut2OJcSF68Qx8dgv8tmqEL1gQaaARtp5A+N4NzB0lMXxon/uxbI8gIYjB9HytGYuusfiPIQcN71kjgnW6VeFOkgh3XcHLvAwMSDPohOADdYQJdF1FtLMZPmslvhZJk2ahkgRvq4HHUoWHRDqTEDDl2mDkfheiDgt8pw340/EocuClCuFvboQzb0cwIZgki4KhzlaE6w0InipbVzBfqoK/qRH94i0rgokSFeO11iBkp8EdV8cfJo0yD75aE2ZNRvSJ0lZKcBXLaUYmQrCzDT6tDN5SyRqYlWeDLZAg0H4JQ+Jt6M3atNLE10VSwQsN4Z6r0CBwqzXesHmV+BeoyAUri8EyMfi2FowXS5dhd7doo2DVII0V5BAjigP89GEVAtda8b2ehodU4rNaAW+dGfzlFkyo89GTlcrHYCLpKD+V7yeeHNzLjkp24Uu1Ed6G8/F8qjqGRzlbl2H2dzjpMg1KdwsHxOlmJ7GTeZC/nesXbeZ6c9OYnuxUc3fmBuFft/Ff8xMd0s65SXIb/gAAAABJRU5ErkJggg=="></a>
                </td>
              </tr>
            </tfoot>
          </table>
          <br>
          <button onclick="newItem();">New Item</button>
        </div>

        <script>
          function hexToDec(hex) {
            var result = 0, digitValue;
            hex = hex.toLowerCase();
            for (var i = 0; i < hex.length; i++) {
              digitValue  = '0123456789abcdefgh'.indexOf(hex[i]);
              result = result * 16 + digitValue;
            }
            return result;
          }

          // TODO refactor into canserver.js once chance of merge conflicts is reduced
          const analysis = document.getElementById('analysis');
          const getJSON = url => fetch(url).then(r => r.json());
          const postJSON = (url, data) => fetch(url, { method: 'POST', body: JSON.stringify(data) }).then(r => r.json()).catch(() => {});
          const show = element => element.classList.remove('hidden');
          const hide = element => element.classList.add('hidden');

          getJSON('/analysis_load').then(response => {
            var haveItems = false;
            
            analysis.querySelector('tr#loading').remove();
            Object.keys(response).forEach((k, i) => {
              haveItems = true;
              itemdetails = response[k];
              
              rowCopy = analysis.querySelector("tfoot tr#rowtemplate").cloneNode(true);
              show(rowCopy);
              
              rowCopy.setAttribute('id', k);
              
              rowCopy.querySelector('input.name').value = k;
              rowCopy.querySelector('input.frameid').value = '0x' + itemdetails.frameid.toString(16);
              rowCopy.querySelector('input.startbit').value = itemdetails.startBit;
              rowCopy.querySelector('input.bitlength').value = itemdetails.bitLength;
              rowCopy.querySelector('input.factor').value = itemdetails.factor;
              rowCopy.querySelector('input.signaloffset').value = itemdetails.signalOffset;
              rowCopy.querySelector('input.issigned').setAttribute('checked', itemdetails.isSigned);
              rowCopy.querySelector('input.littleendian').setAttribute('checked', itemdetails.byteOrder);
              
              analysis.querySelector('table tbody').appendChild(rowCopy);
            });

            if (!haveItems) {
              show(analysis.querySelector('tr#noitems'))
            }
          });
          
          function newItem()
          {
            rowCopy = analysis.querySelector("tfoot tr#rowtemplate").cloneNode(true);
            show(rowCopy);
              
            rowCopy.setAttribute('id', '----new----');
              
            analysis.querySelector('table tbody').appendChild(rowCopy);
            hide(analysis.querySelector('tr#noitems'));
          }
          
          function saveItem(rowhref)
          {
            rowToWorkOn = rowhref.parentElement.parentElement;
            
            var newName = rowToWorkOn.querySelector('input.name').value;
            
            var foundNameCount = 0;
            analysis.querySelectorAll('input.name').forEach(function (obj, i) {
              if (obj.value == newName) {
                foundNameCount++;
              }
            });
            
            if (foundNameCount == 1)
            {
              postInfo = {};
              if (rowToWorkOn.getAttribute('id') === "----new----") {
                postInfo['state'] = 'new';
              } else {
                postInfo['state'] = 'update';
              }
              
              postInfo['name'] = newName;
              postInfo['frameid'] = hexToDec(rowToWorkOn.querySelector('input.frameid').value.substr(2));
              postInfo['startbit'] = Number(rowToWorkOn.querySelector('input.startbit').value);
              postInfo['bitlength'] = Number(rowToWorkOn.querySelector('input.bitlength').value);
              postInfo['factor'] = Number(rowToWorkOn.querySelector('input.factor').value);
              postInfo['signaloffset'] = Number(rowToWorkOn.querySelector('input.signaloffset').value);
              postInfo['issigned'] = rowToWorkOn.querySelector('input.issigned').getAttribute('checked');
              postInfo['littleendian'] = rowToWorkOn.querySelector('input.littleendian').getAttribute('checked');
              
              postJSON('/analysis_save', postInfo).then(() => {
                window.location = "/analysis";
              });
            }
            else
            {
              alert('You can\'t have duplicate names.  Please choose a unique name');
            }
          }
          
          function deleteItem(rowhref)
          {
            rowToWorkOn = rowhref.parentElement.parentElement;

            if (rowToWorkOn.getAttribute('id') === "----new----") {
              rowToWorkOn.remove();
            }
            else
            {
              var shouldDelete = confirm('Are you sure you want to delete this item?  If any displays are referencing it they will stop being able to display this data point.');
              if (shouldDelete)
              {
                postInfo = {};
                postInfo['name'] = rowToWorkOn.getAttribute('id');

                postJSON('/analysis_delete', postInfo).then(() => {
                  window.location = "/analysis";
                });
              }
            }
          }
          
          function updateLoad() {
            getJSON('/analysis_update').then(response => {
              Object.keys(response).forEach((k, i) => {
                  analysis.querySelector('tr#' + k + ' td.value').innerHTML = response[k];
                });
            });
          }
          
          setInterval('updateLoad()', 1000);
        </script>
      </main>
      <footer>
        <span>
          Github: <a href="https://github.com/joshwardell/CANserver">https://github.com/joshwardell/CANserver</a>
        </span>
        <span>
        <label for="theme">Visual theme:</label>
          <select name="theme" id="theme">
            <option value="business">Business</option>
            <option value="pastel">Pastel</option>
          </select> 
        </span>
      </footer>
    </body>
</html>